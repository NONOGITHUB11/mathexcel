<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MathExcel ‚Äî Mon Espace</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --purple:#6C3FC5;--purple-light:#8B62D9;--purple-dark:#4A2A8F;
      --purple-glow:rgba(108,63,197,.25);--gold:#F5C842;--green:#2ECC8A;--red:#FF6B6B;--blue:#4FC3F7;
      --bg:#0E0B1A;--surface:#16112A;--surface2:#1E1735;--surface3:#251E3E;
      --text:#F0EBF8;--text-muted:#9B8FBB;--border:rgba(108,63,197,.2);--r:16px;
    }
    body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
    body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(108,63,197,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(108,63,197,.04) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
    .sidebar{position:fixed;top:0;left:0;width:240px;height:100vh;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:28px 0;z-index:10;}
    .sidebar-logo{padding:0 24px 28px;border-bottom:1px solid var(--border);}
    .logo-row{display:flex;align-items:center;gap:12px;}
    .logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--purple),var(--purple-light));border-radius:12px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:800;font-size:15px;color:white;flex-shrink:0;}
    .logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:18px;}
    .nav{flex:1;padding:20px 12px;display:flex;flex-direction:column;gap:4px;}
    .nav-section{font-size:10px;font-weight:600;letter-spacing:1.5px;color:var(--text-muted);text-transform:uppercase;padding:16px 12px 6px;}
    .nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:500;color:var(--text-muted);transition:all .15s;border:1px solid transparent;text-decoration:none;}
    .nav-item:hover{background:var(--surface2);color:var(--text);}
    .nav-item.active{background:linear-gradient(135deg,rgba(108,63,197,.25),rgba(139,98,217,.15));color:var(--text);border-color:var(--border);}
    .nav-item .icon{font-size:16px;width:20px;text-align:center;}
    .sidebar-bottom{padding:20px 12px 0;border-top:1px solid var(--border);margin:0 12px;}
    .s-card{display:flex;align-items:center;gap:10px;padding:10px;background:var(--surface2);border-radius:10px;border:1px solid var(--border);}
    .s-avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-weight:700;font-size:13px;color:white;flex-shrink:0;}
    .s-info{flex:1;min-width:0;}
    .s-name{font-size:13px;font-weight:600;}
    .s-role{font-size:11px;color:var(--text-muted);}
    .logout-btn{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px;padding:4px;border-radius:6px;transition:color .15s;}
    .logout-btn:hover{color:var(--red);}
    .main{margin-left:240px;min-height:100vh;position:relative;z-index:1;}
    .topbar{padding:24px 32px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(14,11,26,.8);backdrop-filter:blur(10px);position:sticky;top:0;z-index:5;}
    .topbar h1{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;}
    .topbar p{font-size:13px;color:var(--text-muted);margin-top:2px;}
    .week-badge{background:linear-gradient(135deg,var(--purple-dark),var(--purple));border:1px solid var(--border);border-radius:10px;padding:8px 16px;font-size:13px;font-weight:500;}
    .panel{display:none;}.panel.active{display:block;}
    .content{padding:32px;}
    .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px;}
    .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:20px;position:relative;overflow:hidden;}
    .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
    .stat-card.c1::before{background:linear-gradient(90deg,var(--purple),var(--purple-light));}
    .stat-card.c2::before{background:linear-gradient(90deg,var(--gold),#ffaa00);}
    .stat-card.c3::before{background:linear-gradient(90deg,var(--green),#00d4aa);}
    .stat-card.c4::before{background:linear-gradient(90deg,var(--blue),#0080c0);}
    .stat-label{font-size:11px;font-weight:600;letter-spacing:1px;color:var(--text-muted);text-transform:uppercase;}
    .stat-value{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;margin:8px 0 4px;}
    .stat-sub{font-size:12px;color:var(--text-muted);}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;}
    .grid-3{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:20px;}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:24px;margin-bottom:20px;}
    .card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
    .card-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
    .card-action{font-size:12px;color:var(--purple-light);cursor:pointer;border:none;background:none;}
    .card-action:hover{text-decoration:underline;}
    .week-plan{display:flex;flex-direction:column;gap:8px;}
    .day-row{display:flex;align-items:flex-start;gap:12px;padding:12px;background:var(--surface2);border-radius:10px;border:1px solid transparent;}
    .day-row.today{border-color:var(--purple);background:rgba(108,63,197,.08);}
    .day-label{font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;width:32px;flex-shrink:0;padding-top:2px;}
    .day-row.today .day-label{color:var(--purple-light);}
    .day-tasks{flex:1;display:flex;flex-direction:column;gap:4px;}
    .task-pill{display:inline-flex;align-items:center;gap:6px;border-radius:6px;padding:4px 10px;font-size:12px;}
    .task-pill.cours{background:rgba(108,63,197,.2);color:var(--purple-light);}
    .task-pill.exo{background:rgba(46,204,138,.15);color:var(--green);}
    .task-pill.revise{background:rgba(245,200,66,.15);color:var(--gold);}
    .task-pill .dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0;}
    .chapter-list{display:flex;flex-direction:column;gap:8px;}
    .chapter-item{display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--surface2);border-radius:12px;border:1px solid var(--border);cursor:pointer;transition:all .15s;color:var(--text);}
    .chapter-item:hover:not(.locked){background:var(--surface3);border-color:var(--purple);transform:translateX(4px);}
    .chapter-item.locked{opacity:.5;cursor:default;}
    .chapter-num{width:36px;height:36px;background:linear-gradient(135deg,var(--purple-dark),var(--purple));border-radius:10px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:white;flex-shrink:0;}
    .chapter-info{flex:1;}
    .chapter-name{font-size:14px;font-weight:600;margin-bottom:2px;}
    .chapter-meta{font-size:12px;color:var(--text-muted);}
    .ch-status{font-size:11px;font-weight:600;padding:4px 10px;border-radius:20px;}
    .s-done{background:rgba(46,204,138,.15);color:var(--green);}
    .s-current{background:rgba(108,63,197,.2);color:var(--purple-light);}
    .s-locked{background:var(--surface3);color:var(--text-muted);}
    .back-btn{display:inline-flex;align-items:center;gap:8px;color:var(--text-muted);font-size:14px;cursor:pointer;margin-bottom:20px;border:none;background:none;}
    .back-btn:hover{color:var(--text);}
    .resources-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px;}
    .resource-card{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center;cursor:pointer;transition:all .15s;}
    .resource-card:hover{border-color:var(--purple-light);background:var(--surface3);}
    .resource-card.disabled{opacity:.4;cursor:default;}
    .resource-icon{font-size:28px;margin-bottom:8px;}
    .resource-label{font-size:13px;font-weight:600;}
    .resource-sub{font-size:11px;color:var(--text-muted);margin-top:4px;}
    .progress-label{display:flex;justify-content:space-between;font-size:12px;color:var(--text-muted);margin-bottom:6px;}
    .progress-bar{height:6px;background:var(--surface3);border-radius:3px;overflow:hidden;}
    .progress-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--purple),var(--purple-light));}
    .replay-list{display:flex;flex-direction:column;gap:10px;}
    .replay-item{display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--surface2);border-radius:12px;border:1px solid var(--border);cursor:pointer;transition:all .15s;color:var(--text);}
    .replay-item:hover{border-color:var(--purple-light);}
    .replay-thumb{width:48px;height:36px;background:linear-gradient(135deg,var(--purple-dark),var(--surface3));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
    .replay-info{flex:1;}
    .replay-title{font-size:14px;font-weight:500;margin-bottom:2px;}
    .replay-meta{font-size:12px;color:var(--text-muted);}
    .replay-dur{font-size:12px;font-weight:600;color:var(--text-muted);background:var(--surface3);padding:4px 10px;border-radius:20px;}
    .eval-item{padding:16px;background:var(--surface2);border-radius:12px;border:1px solid var(--border);margin-bottom:10px;}
    .eval-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
    .eval-name{font-size:14px;font-weight:600;}
    .eval-date{font-size:12px;color:var(--text-muted);}
    .eval-note{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;}
    .eval-note.good{color:var(--green);}.eval-note.ok{color:var(--gold);}.eval-note.bad{color:var(--red);}
    .eval-comment{font-size:12px;color:var(--text-muted);margin-top:6px;line-height:1.5;}
    .eval-tags{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
    .eval-tag{font-size:11px;padding:3px 8px;border-radius:5px;background:var(--surface3);color:var(--text-muted);}
    .src-badge{font-size:10px;color:var(--purple-light);background:rgba(108,63,197,.15);padding:2px 6px;border-radius:4px;margin-left:6px;}
    .field{margin-bottom:14px;}
    .field label{display:block;font-size:12px;font-weight:600;letter-spacing:.5px;color:var(--text-muted);text-transform:uppercase;margin-bottom:7px;}
    .field input,.field textarea,.field select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:11px 14px;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--text);outline:none;transition:border-color .15s,box-shadow .15s;}
    .field input:focus,.field textarea:focus,.field select:focus{border-color:var(--purple-light);box-shadow:0 0 0 3px rgba(108,63,197,.2);}
    .field input::placeholder,.field textarea::placeholder{color:var(--text-muted);}
    .field textarea{resize:vertical;min-height:70px;}
    .field select option{background:var(--surface2);}
    .fr2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
    .add-btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:11px;background:none;border:1px dashed var(--border);border-radius:10px;color:var(--text-muted);font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;margin-top:8px;}
    .add-btn:hover{border-color:var(--purple-light);color:var(--purple-light);}
    .del-btn{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:14px;padding:4px 8px;border-radius:6px;transition:all .15s;}
    .del-btn:hover{background:rgba(255,107,107,.1);color:var(--red);}
    .calendar-placeholder{height:280px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;color:var(--text-muted);font-size:14px;background:var(--surface2);border-radius:12px;}
    .cal-btn{background:linear-gradient(135deg,var(--purple),var(--purple-light));color:white;border:none;border-radius:12px;padding:12px 24px;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(108,63,197,.25);transition:all .15s;}
    .cal-btn:hover{transform:translateY(-2px);}
    .next-session{background:linear-gradient(135deg,rgba(108,63,197,.2),rgba(139,98,217,.1));border:1px solid var(--purple);border-radius:14px;padding:20px;display:flex;align-items:center;gap:16px;margin-bottom:20px;}
    .ns-icon{font-size:32px;}
    .ns-info{flex:1;}
    .ns-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;}
    .ns-time{font-size:13px;color:var(--text-muted);margin-top:4px;}
    .ns-join{background:linear-gradient(135deg,var(--purple),var(--purple-light));color:white;border:none;border-radius:10px;padding:10px 20px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .15s;}
    .ns-join:hover{transform:translateY(-2px);}
    .ns-join:disabled{opacity:.5;cursor:not-allowed;transform:none;}
    .obj-list{display:flex;flex-direction:column;gap:8px;}
    .obj-item{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface2);border-radius:10px;border:1px solid var(--border);font-size:13px;}
    .obj-check{width:22px;height:22px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;cursor:pointer;transition:all .15s;}
    .obj-check.done{background:rgba(46,204,138,.2);color:var(--green);border:1px solid var(--green);}
    .obj-check.pending{background:var(--surface3);border:1px solid var(--border);color:transparent;}
    .obj-check.pending:hover{border-color:var(--purple-light);}
    .obj-text.done{text-decoration:line-through;color:var(--text-muted);}
    .obj-src{font-size:10px;color:var(--text-muted);margin-left:auto;flex-shrink:0;white-space:nowrap;}
    .toast{position:fixed;bottom:28px;right:28px;background:var(--surface);border:1px solid var(--green);color:var(--green);border-radius:12px;padding:14px 20px;font-size:14px;font-weight:500;display:flex;align-items:center;gap:10px;transform:translateY(80px);opacity:0;transition:all .3s cubic-bezier(.34,1.56,.64,1);z-index:100;box-shadow:0 8px 32px rgba(0,0,0,.4);}
    .toast.show{transform:translateY(0);opacity:1;}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:50;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
    .modal-overlay.open{opacity:1;pointer-events:all;}
    .modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:32px;width:90%;max-width:460px;transform:scale(.95);transition:transform .2s cubic-bezier(.34,1.56,.64,1);}
    .modal-overlay.open .modal{transform:scale(1);}
    .modal h3{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;margin-bottom:6px;}
    .modal p{font-size:13px;color:var(--text-muted);margin-bottom:20px;line-height:1.6;}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;}
    .btn-cancel{background:var(--surface2);border:1px solid var(--border);color:var(--text-muted);border-radius:10px;padding:10px 18px;font-size:13px;cursor:pointer;}
    .btn-cancel:hover{color:var(--text);}
    .btn-ok{background:linear-gradient(135deg,var(--purple),var(--purple-light));color:white;border:none;border-radius:10px;padding:10px 18px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;cursor:pointer;}
    .coach-box{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px;font-size:14px;line-height:1.7;color:var(--text-muted);}
    .coach-box strong{color:var(--text);}
    .coach-box em{color:var(--purple-light);}
    .inline-input-row{display:flex;gap:8px;margin-top:12px;}
    .inline-input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--text);outline:none;}
    .inline-input:focus{border-color:var(--purple-light);}
    .inline-btn{background:var(--purple);color:white;border:none;border-radius:10px;padding:10px 16px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;}
  </style>
</head>
<body>
<aside class="sidebar">
  <div class="sidebar-logo"><div class="logo-row"><div class="logo-icon">M‚àë</div><span class="logo-text">MathExcel</span></div></div>
  <nav class="nav">
    <div class="nav-section">Mon espace</div>
    <a class="nav-item active" onclick="showPanel('dashboard',this)" href="#"><span class="icon">üè†</span><span>Tableau de bord</span></a>
    <a class="nav-item" onclick="showPanel('cours',this)" href="#"><span class="icon">üìö</span><span>Mes cours</span></a>
    <a class="nav-item" onclick="showPanel('replays',this)" href="#"><span class="icon">üé•</span><span>Replays</span></a>
    <a class="nav-item" onclick="showPanel('evals',this)" href="#"><span class="icon">üìä</span><span>Mes √©vals</span></a>
    <div class="nav-section">Organisation</div>
    <a class="nav-item" onclick="showPanel('agenda',this)" href="#"><span class="icon">üìÖ</span><span>Mon agenda</span></a>
    <a class="nav-item" onclick="showPanel('objectifs',this)" href="#"><span class="icon">üéØ</span><span>Objectifs</span></a>
  </nav>
  <div class="sidebar-bottom">
    <div class="s-card">
      <div class="s-avatar" id="sbAvatar">T</div>
      <div class="s-info"><div class="s-name" id="sbName">√âl√®ve</div><div class="s-role">Terminale Sp√©</div></div>
      <button class="logout-btn" onclick="logout()">‚Ü™</button>
    </div>
  </div>
</aside>

<main class="main">
  <div class="topbar">
    <div><h1 id="panelTitle">Tableau de bord</h1><p id="panelSub"></p></div>
    <div class="week-badge" id="weekBadge">‚Äî</div>
  </div>

  <!-- DASHBOARD -->
  <div class="panel active content" id="panel-dashboard">
    <div class="stats-row" id="dashStats"></div>
    <div id="dashSession"></div>
    <div class="grid-3">
      <div class="card">
        <div class="card-header"><div class="card-title">üìÖ Planning semaine</div><button class="card-action" onclick="showPanel('agenda',null)">Agenda ‚Üí</button></div>
        <div class="week-plan" id="weekPlanDash"></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">üìà Progression</div></div>
        <div id="progressBars"></div>
        <div style="margin-top:20px;"><div class="card-title" style="margin-bottom:12px;">üéØ Objectifs</div><div class="obj-list" id="quickObj"></div></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title">üé• Derniers replays</div><button class="card-action" onclick="showPanel('replays',null)">Voir tous ‚Üí</button></div>
      <div class="replay-list" id="dashReplays"></div>
    </div>
  </div>

  <!-- COURS -->
  <div class="panel content" id="panel-cours">
    <div id="chapListView">
      <div class="card">
        <div class="card-header">
          <div class="card-title">üìö Programme Terminale</div>
          <span style="font-size:13px;color:var(--text-muted);" id="chapProgress">‚Äî</span>
        </div>
        <div class="progress-bar" style="margin-bottom:24px;"><div class="progress-fill" id="chapBar" style="width:0%"></div></div>
        <div class="chapter-list" id="chapList"></div>
      </div>
    </div>
    <div id="chapDetail" style="display:none;">
      <button class="back-btn" onclick="closeDetail()">‚Üê Retour</button>
      <div class="card">
        <div class="card-header"><div class="card-title" id="detailTitle"></div><span class="ch-status" id="detailStatus"></span></div>
        <div class="resources-grid" id="detailRes"></div>
      </div>
    </div>
  </div>

  <!-- REPLAYS -->
  <div class="panel content" id="panel-replays">
    <div class="card">
      <div class="card-header"><div class="card-title">üé• Replays des s√©ances</div><span style="font-size:13px;color:var(--text-muted);" id="replayCount">‚Äî</span></div>
      <div class="replay-list" id="allReplays"></div>
      <div id="noReplays" style="display:none;text-align:center;padding:32px;color:var(--text-muted);font-size:14px;">Aucun replay disponible.</div>
    </div>
  </div>

  <!-- EVALS -->
  <div class="panel content" id="panel-evals">
    <div class="stats-row" id="evalStats" style="grid-template-columns:repeat(3,1fr);margin-bottom:24px;"></div>
    <div class="card">
      <div class="card-title" style="margin-bottom:16px;">‚ûï Ajouter une √©valuation</div>
      <div class="fr2">
        <div class="field"><label>Nom du DS</label><input id="eName" placeholder="DS Suites ‚Äî R√©currence" /></div>
        <div class="field"><label>Date</label><input id="eDate" placeholder="1 mar 2025" /></div>
      </div>
      <div class="fr3">
        <div class="field"><label>Note</label><input type="number" id="eNote" placeholder="15" min="0" max="20" /></div>
        <div class="field"><label>Sur</label><input type="number" id="eMax" value="20" /></div>
        <div class="field"><label>Appr√©ciation</label><select id="eClass"><option value="good">üü¢ Bon</option><option value="ok">üü° Moyen</option><option value="bad">üî¥ √Ä retravailler</option></select></div>
      </div>
      <div class="field"><label>Commentaire</label><textarea id="eComment" placeholder="Ce qui s'est bien pass√©, √† retravailler..."></textarea></div>
      <div class="field"><label>Tags (virgules)</label><input id="eTags" placeholder="R√©currence, M√©thode..." /></div>
      <button class="add-btn" onclick="addEval()">‚ûï Ajouter cette √©valuation</button>
    </div>
    <div class="card">
      <div class="card-title" style="margin-bottom:16px;">üìä Historique</div>
      <div id="evalList"></div>
      <div id="noEvals" style="display:none;text-align:center;padding:32px;color:var(--text-muted);font-size:14px;">Aucune √©valuation.</div>
    </div>
  </div>

  <!-- AGENDA -->
  <div class="panel content" id="panel-agenda">
    <div id="agendaSession"></div>
    <div class="card">
      <div class="card-header">
        <div class="card-title">üìÖ Mon Google Agenda</div>
        <button class="card-action" onclick="openCalModal()">‚öôÔ∏è Configurer</button>
      </div>
      <div id="calDisplay"></div>
    </div>
  </div>

  <!-- OBJECTIFS -->
  <div class="panel content" id="panel-objectifs">
    <div class="grid-2">
      <div class="card">
        <div class="card-header"><div class="card-title">üéØ Objectifs de la semaine</div></div>
        <div class="obj-list" id="objList"></div>
        <div class="inline-input-row">
          <input class="inline-input" id="newObjInput" placeholder="Ajouter un objectif personnel..." />
          <button class="inline-btn" onclick="addPersonalObj()">Ajouter</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title" style="margin-bottom:16px;">üí¨ Message de ton coach</div>
        <div class="coach-box" id="coachBox"></div>
        <div style="margin-top:12px;padding:12px 14px;background:rgba(108,63,197,.1);border-radius:10px;font-size:13px;color:var(--text-muted);border:1px solid var(--border);">üìû Des questions ? <strong style="color:var(--purple-light);">WhatsApp ton coach</strong></div>
      </div>
    </div>
  </div>
</main>

<!-- Calendar modal -->
<div class="modal-overlay" id="calModal">
  <div class="modal">
    <h3>üìÖ Connecter ton Google Agenda</h3>
    <p>1. Va sur <strong style="color:var(--purple-light)">calendar.google.com</strong><br/>2. ‚öôÔ∏è Param√®tres ‚Üí ton agenda ‚Üí "Int√©grer l'agenda"<br/>3. Copie l'URL dans la balise <code style="background:var(--surface2);padding:2px 6px;border-radius:4px">src="..."</code></p>
    <div class="field"><label>Colle ton URL ici</label><input type="url" id="calInput" placeholder="https://calendar.google.com/calendar/embed?src=..." /></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeCalModal()">Annuler</button>
      <button class="btn-ok" onclick="saveCalUrl()">Connecter ‚Üí</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">‚úì <span id="toastMsg"></span></div>

<script>
// AUTH
const student = JSON.parse(sessionStorage.getItem('student') || 'null');
if (!student) { window.location.href = 'index.html'; }
document.getElementById('sbName').textContent = student?.name || '√âl√®ve';
document.getElementById('sbAvatar').textContent = (student?.name||'E')[0].toUpperCase();
if (student?.color) document.getElementById('sbAvatar').style.background = student.color;
function logout(){ sessionStorage.removeItem('student'); window.location.href='index.html'; }

// WEEK BADGE
const now=new Date(), ws=new Date(now);
ws.setDate(now.getDate()-((now.getDay()+6)%7));
document.getElementById('weekBadge').textContent=`Semaine du ${ws.toLocaleDateString('fr-FR',{day:'numeric',month:'long'})}`;

// STATE ‚Äî loaded from data.json on GitHub (same repo as this site)
let _adminCache = null;

function getAdmin(){
  return _adminCache || {agendaUrl:'',meetTitle:'',meetDate:'',meetUrl:'',weekPlan:[
    {day:'LUN',tasks:[]},{day:'MAR',tasks:[{text:'Vid√©o du cours',type:'cours'}]},
    {day:'MER',tasks:[{text:'Exercices niv.1',type:'exo'}]},{day:'JEU',tasks:[{text:'R√©vision fiche',type:'revise'}]},
    {day:'VEN',tasks:[{text:'Exercices niv.2',type:'exo'}]},{day:'SAM',tasks:[{text:'Cours 14h-15h30',type:'cours'}]},
    {day:'DIM',tasks:[]},
  ],replays:[],chapters:[
    {num:1,name:'Suites ‚Äî Raisonnement par r√©currence',meta:'Fiche ¬∑ Vid√©o ¬∑ Exercices',status:'done',fiche:'',video:'',exercices:''},
    {num:2,name:'Suites ‚Äî Limites',meta:'Fiche ¬∑ Vid√©o ¬∑ Exercices',status:'current',fiche:'',video:'',exercices:''},
    {num:3,name:'Suites ‚Äî Op√©rations sur les limites',meta:'Fiche ¬∑ Vid√©o ¬∑ Exercices',status:'locked',fiche:'',video:'',exercices:''},
    {num:4,name:'D√©rivation',meta:'Fiche ¬∑ Vid√©o ¬∑ Exercices',status:'done',fiche:'',video:'',exercices:''},
    {num:5,name:'Fonction exponentielle',meta:'Fiche ¬∑ Vid√©o ¬∑ Exercices',status:'locked',fiche:'',video:'',exercices:''},
    {num:6,name:'Fonctions trigonom√©triques',meta:'Fiche ¬∑ Vid√©o ¬∑ Exercices',status:'locked',fiche:'',video:'',exercices:''},
    {num:7,name:'Produit scalaire',meta:'Fiche ¬∑ Vid√©o ¬∑ Exercices',status:'locked',fiche:'',video:'',exercices:''},
    {num:8,name:'G√©om√©trie rep√©r√©e',meta:'Fiche ¬∑ Vid√©o ¬∑ Exercices',status:'locked',fiche:'',video:'',exercices:''},
    {num:9,name:'Probabilit√©s conditionnelles',meta:'Fiche ¬∑ Vid√©o ¬∑ Exercices',status:'done',fiche:'',video:'',exercices:''},
    {num:10,name:'Variables al√©atoires',meta:'Fiche ¬∑ Vid√©o ¬∑ Exercices',status:'done',fiche:'',video:'',exercices:''},
    {num:11,name:'Loi binomiale',meta:'Fiche ¬∑ Vid√©o ¬∑ Exercices',status:'locked',fiche:'',video:'',exercices:''},
    {num:12,name:'Algorithmique Python',meta:'Fiche ¬∑ Vid√©o ¬∑ Exercices',status:'locked',fiche:'',video:'',exercices:''},
  ],objectives:[],message:{title:'',body:'',cta:''},evals:[]};
}

// Fetch data.json directly from GitHub (public raw URL ‚Äî no token needed for reading)
async function loadAdminData(){
  try{
    // data.json is in the same repo, served by Vercel at /data.json
    const r = await fetch('/data.json?_='+Date.now());
    if(!r.ok) throw new Error('not found');
    _adminCache = await r.json();
  } catch(e){
    console.warn('Could not load data.json:', e.message);
  }
}
const SK=`mathexcel_student_${student?.email||'x'}`;
function getSd(){ return JSON.parse(localStorage.getItem(SK)||'null')||{calUrl:'',evals:[],personalObjs:[],objDone:{}}; }
function saveSd(d){ localStorage.setItem(SK,JSON.stringify(d)); }

// TOAST
let tt;
function toast(msg,c='var(--green)'){
  const t=document.getElementById('toast'); t.style.borderColor=c; t.style.color=c;
  document.getElementById('toastMsg').textContent=msg; t.classList.add('show');
  clearTimeout(tt); tt=setTimeout(()=>t.classList.remove('show'),2500);
}
function openUrl(u){ if(u&&u!='#') window.open(u,'_blank'); else toast('Lien non configur√©','var(--gold)'); }

// PANEL NAV
const META={dashboard:{title:'Tableau de bord',sub:'Bienvenue '+student?.name+' üéØ'},cours:{title:'Mes cours',sub:'Programme Terminale Sp√© Maths'},replays:{title:'Replays',sub:'S√©ances enregistr√©es'},evals:{title:'Mes √©valuations',sub:'Ajoute tes notes et suis ta progression'},agenda:{title:'Mon agenda',sub:'Ton planning et ta prochaine s√©ance'},objectifs:{title:'Objectifs',sub:'T√¢ches de la semaine'}};
async function showPanel(id,el){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('panel-'+id).classList.add('active');
  if(el) el.classList.add('active');
  else { const a=document.querySelector(`[onclick*="'${id}'"]`); if(a) a.classList.add('active'); }
  document.getElementById('panelTitle').textContent=META[id].title;
  document.getElementById('panelSub').textContent=META[id].sub;
  ({dashboard:renderDash,cours:renderCours,replays:renderReplays,evals:renderEvals,agenda:renderAgenda,objectifs:renderObjectifs}[id]||Function)();
}

// ‚îÄ‚îÄ NEXT SESSION
function renderSession(id){
  const a=getAdmin(), el=document.getElementById(id); if(!el) return;
  if(!a.meetTitle){ el.innerHTML=''; return; }
  el.innerHTML=`<div class="next-session"><div class="ns-icon">üìπ</div><div class="ns-info"><div class="ns-title">${a.meetTitle}</div><div class="ns-time">${a.meetDate||''}</div></div><button class="ns-join" ${a.meetUrl?'':'disabled'} onclick="openUrl('${a.meetUrl}')">${a.meetUrl?'Rejoindre ‚Üí':'Lien √† venir'}</button></div>`;
}

// ‚îÄ‚îÄ DASHBOARD
function renderDash(){
  const a=getAdmin(), sd=getSd();
  const allE=[...(a.evals||[]),...(sd.evals||[])];
  const done=(a.chapters||[]).filter(c=>c.status==='done').length;
  const avg=allE.length?(allE.reduce((s,e)=>s+(e.note/e.max*20),0)/allE.length).toFixed(1):'‚Äî';
  document.getElementById('dashStats').innerHTML=`
    <div class="stat-card c1"><div class="stat-label">S√©ances</div><div class="stat-value">${(a.replays||[]).length}</div><div class="stat-sub">enregistr√©es</div></div>
    <div class="stat-card c2"><div class="stat-label">Moyenne</div><div class="stat-value">${avg}</div><div class="stat-sub">sur 20</div></div>
    <div class="stat-card c3"><div class="stat-label">Chapitres</div><div class="stat-value">${done}/${(a.chapters||[]).length}</div><div class="stat-sub">termin√©s</div></div>
    <div class="stat-card c4"><div class="stat-label">√âvals</div><div class="stat-value">${allE.length}</div><div class="stat-sub">enregistr√©es</div></div>`;
  renderSession('dashSession');
  const today=['DIM','LUN','MAR','MER','JEU','VEN','SAM'][new Date().getDay()];
  const wp=document.getElementById('weekPlanDash'); wp.innerHTML='';
  (a.weekPlan||[]).forEach(d=>{
    const r=document.createElement('div'); r.className='day-row'+(d.day===today?' today':'');
    const tasks=d.tasks.length?d.tasks.map(t=>`<span class="task-pill ${t.type}"><span class="dot"></span>${t.text}</span>`).join(''):`<span style="font-size:12px;color:var(--text-muted)">Repos</span>`;
    r.innerHTML=`<div class="day-label">${d.day}</div><div class="day-tasks">${tasks}</div>`; wp.appendChild(r);
  });
  const chap=a.chapters||[];
  document.getElementById('progressBars').innerHTML=`
    <div><div class="progress-label"><span>Chapitres</span><span>${done}/${chap.length}</span></div><div class="progress-bar"><div class="progress-fill" style="width:${chap.length?Math.round(done/chap.length*100):0}%"></div></div></div>
    <div style="margin-top:12px;"><div class="progress-label"><span>√âvaluations</span><span>${allE.length}</span></div><div class="progress-bar"><div class="progress-fill" style="width:${Math.min(allE.length*10,100)}%"></div></div></div>`;
  const allObjs=[...(a.objectives||[]).map(o=>({...o,key:'a'+a.objectives.indexOf(o)})),...(sd.personalObjs||[]).map((o,i)=>({...o,key:'p'+i}))];
  const qo=document.getElementById('quickObj'); qo.innerHTML='';
  allObjs.slice(0,3).forEach(o=>{
    const done2=sd.objDone&&sd.objDone[o.key]!==undefined?sd.objDone[o.key]:o.done;
    const el=document.createElement('div'); el.className='obj-item';
    el.innerHTML=`<div class="obj-check ${done2?'done':'pending'}">${done2?'‚úì':''}</div><span class="obj-text ${done2?'done':''}">${o.text}</span>`;
    qo.appendChild(el);
  });
  const dr=document.getElementById('dashReplays'); dr.innerHTML='';
  const rr=(a.replays||[]).slice(0,3);
  if(!rr.length){dr.innerHTML='<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:14px;">Aucun replay.</div>';return;}
  rr.forEach(r=>{const el=document.createElement('div');el.className='replay-item';el.onclick=()=>openUrl(r.url);el.innerHTML=`<div class="replay-thumb">üé•</div><div class="replay-info"><div class="replay-title">${r.title}</div><div class="replay-meta">${r.date}</div></div><span class="replay-dur">${r.duration}</span>`;dr.appendChild(el);});
}

// ‚îÄ‚îÄ COURS
function renderCours(){
  const a=getAdmin(), chap=a.chapters||[];
  const done=chap.filter(c=>c.status==='done').length;
  document.getElementById('chapProgress').textContent=`${done}/${chap.length} termin√©s`;
  document.getElementById('chapBar').style.width=chap.length?`${Math.round(done/chap.length*100)}%`:'0%';
  const list=document.getElementById('chapList'); list.innerHTML='';
  chap.forEach((ch,i)=>{
    const el=document.createElement('div'); el.className='chapter-item'+(ch.status==='locked'?' locked':'');
    el.innerHTML=`<div class="chapter-num">${ch.num}</div><div class="chapter-info"><div class="chapter-name">${ch.name}</div><div class="chapter-meta">${ch.meta||'Fiche ¬∑ Vid√©o ¬∑ Exercices'}</div></div><span class="ch-status s-${ch.status}">${{done:'Termin√© ‚úì',current:'En cours',locked:'√Ä venir'}[ch.status]}</span><span style="color:var(--text-muted)">‚Üí</span>`;
    if(ch.status!=='locked') el.onclick=()=>openDetail(i);
    list.appendChild(el);
  });
}
function openDetail(i){
  const ch=getAdmin().chapters[i];
  document.getElementById('chapListView').style.display='none';
  document.getElementById('chapDetail').style.display='block';
  document.getElementById('detailTitle').textContent=`${ch.num}. ${ch.name}`;
  const ds=document.getElementById('detailStatus');
  ds.className=`ch-status s-${ch.status}`; ds.textContent={done:'Termin√© ‚úì',current:'En cours',locked:'√Ä venir'}[ch.status];
  const res=document.getElementById('detailRes'); res.innerHTML='';
  [{label:'Fiche m√©thode',icon:'üìÑ',sub:'T√©l√©charger PDF',url:ch.fiche},{label:'Vid√©o cours',icon:'üé¨',sub:'Regarder',url:ch.video},{label:'Exercices',icon:'üìù',sub:'Acc√©der',url:ch.exercices}].forEach(r=>{
    const el=document.createElement('div'); el.className='resource-card'+(r.url?'':' disabled');
    el.innerHTML=`<div class="resource-icon">${r.icon}</div><div class="resource-label">${r.label}</div><div class="resource-sub">${r.url?r.sub:'Non disponible'}</div>`;
    if(r.url) el.onclick=()=>openUrl(r.url);
    res.appendChild(el);
  });
}
function closeDetail(){ document.getElementById('chapListView').style.display=''; document.getElementById('chapDetail').style.display='none'; }

// ‚îÄ‚îÄ REPLAYS
function renderReplays(){
  const a=getAdmin(), rr=a.replays||[];
  document.getElementById('replayCount').textContent=`${rr.length} s√©ance${rr.length>1?'s':''}`;
  const list=document.getElementById('allReplays'); list.innerHTML='';
  document.getElementById('noReplays').style.display=rr.length?'none':'block';
  rr.forEach(r=>{const el=document.createElement('div');el.className='replay-item';el.onclick=()=>openUrl(r.url);el.innerHTML=`<div class="replay-thumb">üé•</div><div class="replay-info"><div class="replay-title">${r.title}</div><div class="replay-meta">${r.date}</div></div><span class="replay-dur">${r.duration}</span>`;list.appendChild(el);});
}

// ‚îÄ‚îÄ EVALS
function renderEvals(){
  const a=getAdmin(), sd=getSd();
  const all=[...(a.evals||[]).map(e=>({...e,src:'coach'})),...(sd.evals||[]).map(e=>({...e,src:'moi'}))];
  const avg=all.length?(all.reduce((s,e)=>s+(e.note/e.max*20),0)/all.length).toFixed(1):'‚Äî';
  const best=all.length?all.reduce((b,e)=>e.note/e.max>b.note/b.max?e:b,all[0]):null;
  document.getElementById('evalStats').innerHTML=`
    <div class="stat-card c1"><div class="stat-label">Moyenne</div><div class="stat-value">${avg}</div><div class="stat-sub">sur 20</div></div>
    <div class="stat-card c3"><div class="stat-label">Meilleure note</div><div class="stat-value">${best?best.note+'/'+best.max:'‚Äî'}</div><div class="stat-sub">${best?best.name.slice(0,22):'‚Äî'}</div></div>
    <div class="stat-card c2"><div class="stat-label">Total √©vals</div><div class="stat-value">${all.length}</div><div class="stat-sub">enregistr√©es</div></div>`;
  const list=document.getElementById('evalList'); list.innerHTML='';
  document.getElementById('noEvals').style.display=all.length?'none':'block';
  all.forEach((e,gi)=>{
    const studentIdx=gi-(a.evals||[]).length;
    const div=document.createElement('div'); div.className='eval-item';
    div.innerHTML=`<div class="eval-header"><div><div class="eval-name">${e.name}<span class="src-badge">${e.src}</span></div><div class="eval-date">${e.date}</div></div><div style="display:flex;align-items:center;gap:8px;"><div class="eval-note ${e.noteClass}">${e.note}/${e.max}</div>${e.src==='moi'?`<button class="del-btn" onclick="delEval(${studentIdx})">üóë</button>`:''}</div></div>${e.comment?`<div class="eval-comment">${e.comment}</div>`:''}${e.tags&&e.tags.length?`<div class="eval-tags">${e.tags.map(t=>`<span class="eval-tag">${t}</span>`).join('')}</div>`:''}`;
    list.appendChild(div);
  });
}
function addEval(){
  const name=document.getElementById('eName').value.trim(),date=document.getElementById('eDate').value.trim(),note=parseFloat(document.getElementById('eNote').value),max=parseFloat(document.getElementById('eMax').value)||20,noteClass=document.getElementById('eClass').value,comment=document.getElementById('eComment').value.trim(),tagsRaw=document.getElementById('eTags').value.trim();
  if(!name||!date||isNaN(note)){toast('‚ö†Ô∏è Remplis le nom, la date et la note','var(--gold)');return;}
  const sd=getSd(); sd.evals=sd.evals||[];
  sd.evals.unshift({name,date,note,max,noteClass,comment,tags:tagsRaw?tagsRaw.split(',').map(t=>t.trim()):[]});
  saveSd(sd); ['eName','eDate','eNote','eComment','eTags'].forEach(id=>document.getElementById(id).value=''); document.getElementById('eMax').value='20';
  renderEvals(); toast('‚úì √âvaluation ajout√©e !');
}
function delEval(i){ const sd=getSd(); sd.evals.splice(i,1); saveSd(sd); renderEvals(); toast('‚úì Supprim√©e'); }

// ‚îÄ‚îÄ AGENDA
function renderAgenda(){
  renderSession('agendaSession');
  const sd=getSd(), url=sd.calUrl||'';
  const d=document.getElementById('calDisplay');
  d.innerHTML=url?`<div style="border-radius:12px;overflow:hidden;border:1px solid var(--border);"><iframe src="${url}" style="width:100%;height:500px;border:0;" frameborder="0" scrolling="no"></iframe></div>`:`<div class="calendar-placeholder"><div style="font-size:48px;">üìÖ</div><div style="text-align:center;"><strong style="color:var(--text)">Connecte ton Google Agenda</strong><br/>Affiche ton planning directement ici</div><button class="cal-btn" onclick="openCalModal()">Connecter mon agenda ‚Üí</button></div>`;
}
function openCalModal(){ document.getElementById('calModal').classList.add('open'); document.getElementById('calInput').value=getSd().calUrl||''; }
function closeCalModal(){ document.getElementById('calModal').classList.remove('open'); }
function saveCalUrl(){ const sd=getSd(); sd.calUrl=document.getElementById('calInput').value.trim(); saveSd(sd); closeCalModal(); renderAgenda(); toast('‚úì Agenda connect√© !'); }

// ‚îÄ‚îÄ OBJECTIFS
function renderObjectifs(){
  const a=getAdmin(), sd=getSd();
  const adminObjs=(a.objectives||[]).map((o,i)=>({...o,key:'a'+i,deletable:false}));
  const personalObjs=(sd.personalObjs||[]).map((o,i)=>({...o,key:'p'+i,deletable:true}));
  const all=[...adminObjs,...personalObjs];
  const list=document.getElementById('objList'); list.innerHTML='';
  if(!all.length){list.innerHTML='<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:14px;">Aucun objectif pour l\'instant.</div>';return;}
  all.forEach(o=>{
    const done=sd.objDone&&sd.objDone[o.key]!==undefined?sd.objDone[o.key]:o.done;
    const el=document.createElement('div'); el.className='obj-item';
    el.innerHTML=`<div class="obj-check ${done?'done':'pending'}">${done?'‚úì':''}</div><span class="obj-text ${done?'done':''}">${o.text}</span><span class="obj-src">${o.source==='coach'||!o.source?'üë®‚Äçüè´':'perso'}</span>${o.deletable?`<button onclick="delObj('${o.key}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:12px;padding:2px 4px;">‚úï</button>`:''}`;
    el.querySelector('.obj-check').addEventListener('click',function(){
      const sd2=getSd(); sd2.objDone=sd2.objDone||{}; sd2.objDone[o.key]=!done; saveSd(sd2); renderObjectifs();
    });
    list.appendChild(el);
  });
  const msg=a.message||{};
  document.getElementById('coachBox').innerHTML=`<strong>${msg.title||'‚Äî'}</strong><br/><br/>${msg.body||'Aucun message.'} ${msg.cta?`<br/><br/><em>${msg.cta}</em>`:''}`;
}
function addPersonalObj(){
  const input=document.getElementById('newObjInput'), text=input.value.trim(); if(!text) return;
  const sd=getSd(); sd.personalObjs=sd.personalObjs||[];
  sd.personalObjs.push({text,done:false,source:'perso'}); saveSd(sd); input.value=''; renderObjectifs();
  toast('‚úì Objectif ajout√© !');
}
function delObj(key){
  const sd=getSd();
  if(key.startsWith('p')){const i=parseInt(key.slice(1));sd.personalObjs.splice(i,1);}
  saveSd(sd); renderObjectifs(); toast('‚úì Supprim√©');
}

// INIT ‚Äî load fresh data from data.json then render
(async function(){
  await loadAdminData();
  renderDash();
})();
</script>
</body>
</html>
